
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Mozilla BigQuery ETL">
      
      
        <meta name="author" content="Mozilla Data Platform Team">
      
      
      
        <link rel="prev" href="../common_workflows/">
      
      
        <link rel="next" href="../testing/">
      
      
      <link rel="icon" href="../../favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.3.1">
    
    
      
        <title>Creating a derived dataset - BigQuery ETL</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.046329b4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#a-quick-guide-to-creating-a-derived-dataset-with-bigquery-etl-and-how-to-set-it-up-as-a-public-dataset" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="BigQuery ETL" class="md-header__button md-logo" aria-label="BigQuery ETL" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BigQuery ETL
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Creating a derived dataset
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mozilla/bigquery-etl/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    mozilla/bigquery-etl
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mozdata/introduction/" class="md-tabs__link">
          
  
  Datasets

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mozfun/about/" class="md-tabs__link">
          
  
  UDFs

        </a>
      </li>
    
  

    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../common_workflows/" class="md-tabs__link">
          
  
  Cookbooks

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bqetl/" class="md-tabs__link">
          
  
  Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="BigQuery ETL" class="md-nav__button md-logo" aria-label="BigQuery ETL" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    BigQuery ETL
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mozilla/bigquery-etl/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    mozilla/bigquery-etl
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Datasets
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Datasets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mozdata
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Mozdata
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/accounts_backend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    accounts-backend
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/accounts_frontend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    accounts-frontend
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/activity_stream/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Activity Stream
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/adjust/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adjust
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/amo_dev/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMO Stats Dev
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/amo_prod/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMO Stats Prod
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/app_store/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    App Store
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/apple_ads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apple Ads
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/bedrock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bedrock
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/bergamot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bergamot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/blpadi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blocklist ADI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/burnham/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    burnham
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/contextual_services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    contextual-services
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/coverage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    coverage
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/debug_ping_view/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    debug-ping-view
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/default_browser_agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    default-browser-agent
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/edge_validator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    edge-validator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/eng_workflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    eng-workflow
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/fenix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fenix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_accounts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox Accounts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_desktop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox Desktop
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_desktop_background_tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firefox-desktop-background-tasks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_desktop_background_update/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firefox-desktop-background-update
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_echo_show/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox Echo Show
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_fire_tv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox Fire Tv
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_installer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firefox-installer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_ios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox iOS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_launcher_process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firefox-launcher-process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_reality/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox Reality
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_reality_pc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox Reality Pc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/firefox_translations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    firefox-translations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/fivetran_costs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fivetran Costs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/focus_android/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Focus Android
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/focus_ios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Focus Ios
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/glean_dictionary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    glean-dictionary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/google_ads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Google_ads
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/hubs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hubs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/internet_outages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Internet Outages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/klar_android/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Klar Android
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/klar_ios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Klar Ios
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/lockwise_android/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lockwise Android
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/lockwise_ios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lockwise Ios
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mach/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mach
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mdn_yari/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mdn-yari
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/messaging_system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    messaging-system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mlhackweek_search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mlhackweek-search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mobile/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mobile
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/monitor_cirrus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    monitor-cirrus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozdata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mozdata
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozilla_lockbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mozilla-lockbox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozilla_mach/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mozilla-mach
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozilla_vpn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mozilla VPN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozillavpn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mozillavpn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozphab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mozphab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozregression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mozregression
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/mozza/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mozza
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/operational_monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Operational Monitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_bergamot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-bergamot
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_connect_firefox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-connect-firefox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_fenix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-fenix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_fenix_nightly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-fenix-nightly
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_fennec_aurora/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-fennec-aurora
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_firefox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-firefox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_firefox_beta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Org Mozilla Firefox Beta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_firefox_vpn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-firefox-vpn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_firefoxreality/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-firefoxreality
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_focus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-focus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_focus_beta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-focus-beta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_focus_nightly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-focus-nightly
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_ios_fennec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-ios-fennec
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_ios_firefox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-ios-firefox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_ios_firefoxbeta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-ios-firefoxbeta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_ios_firefoxvpn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-ios-firefoxvpn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_ios_focus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-ios-focus
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_ios_klar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-ios-klar
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_ios_lockbox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-ios-lockbox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_klar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-klar
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_mozregression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-mozregression
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_reference_browser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-reference-browser
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_tv_firefox/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-tv-firefox
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/org_mozilla_vrbrowser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    org-mozilla-vrbrowser
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/pine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pine
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/pocket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pocket
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/reference_browser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference Browser
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/regrets_reporter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    regrets-reporter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/regrets_reporter_ucs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    regrets-reporter-ucs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/relay/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firefox Relay
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Search
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/search_terms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Search Terms
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/static/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Static Data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/stripe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stripe
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/subscription_platform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Subscription Platform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/telemetry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Telemetry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/treeherder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    treeherder
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/udf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User-Defined Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/udf_js/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User-Defined Functions (Javascript)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/udf_js_lib/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    udf_js_lib
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/udf_legacy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User-Defined Functions (Legacy)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/viu_politica/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    viu-politica
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozdata/webpagetest/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    webpagetest
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    UDFs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            UDFs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mozfun
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Mozfun
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mozfun
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/addons/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Addons
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/bits28/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bits28
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/bytes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bytes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/datetime_util/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    datetime_util.fxa_parse_date
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/event_analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    event_analysis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/glam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Glam
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/glean/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    glean
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/hist/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hist
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/iap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    iap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/json/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    json
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/map/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    map
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/norm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    norm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/stats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    stats
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mozfun/vpn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    vpn
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cookbooks
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Cookbooks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../common_workflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Common workflows
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Creating a derived dataset
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Creating a derived dataset
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-steps" class="md-nav__link">
    Initial steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-query" class="md-nav__link">
    Create the Query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fill-out-the-yaml" class="md-nav__link">
    Fill out the YAML
  </a>
  
    <nav class="md-nav" aria-label="Fill out the YAML">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-yaml-file-structure-for-a-public-dataset" class="md-nav__link">
    The YAML file structure for a public dataset
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fill-out-the-query" class="md-nav__link">
    Fill out the query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-and-validating-the-query" class="md-nav__link">
    Formatting and validating the query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-table-schema" class="md-nav__link">
    Creating the table schema
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-dag" class="md-nav__link">
    Creating a DAG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduling-your-query" class="md-nav__link">
    Scheduling your query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-airflow-dags" class="md-nav__link">
    Updating the Airflow DAGs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-data-review" class="md-nav__link">
    Get Data Review
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-pull-request" class="md-nav__link">
    Create a Pull Request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-an-initial-table" class="md-nav__link">
    Creating an initial table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backfilling-the-dataset" class="md-nav__link">
    Backfilling the dataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#completing-the-pull-request" class="md-nav__link">
    Completing the Pull Request
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../bqetl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bqetl CLI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/recommended_practices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Recommended practices
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/incremental/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Incremental queries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scheduling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/public_data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Public data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/airflow_tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Airflow Tags
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/data_checks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Checks
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initial-steps" class="md-nav__link">
    Initial steps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-query" class="md-nav__link">
    Create the Query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fill-out-the-yaml" class="md-nav__link">
    Fill out the YAML
  </a>
  
    <nav class="md-nav" aria-label="Fill out the YAML">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-yaml-file-structure-for-a-public-dataset" class="md-nav__link">
    The YAML file structure for a public dataset
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fill-out-the-query" class="md-nav__link">
    Fill out the query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-and-validating-the-query" class="md-nav__link">
    Formatting and validating the query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-table-schema" class="md-nav__link">
    Creating the table schema
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-dag" class="md-nav__link">
    Creating a DAG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduling-your-query" class="md-nav__link">
    Scheduling your query
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-airflow-dags" class="md-nav__link">
    Updating the Airflow DAGs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-data-review" class="md-nav__link">
    Get Data Review
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-pull-request" class="md-nav__link">
    Create a Pull Request
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-an-initial-table" class="md-nav__link">
    Creating an initial table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backfilling-the-dataset" class="md-nav__link">
    Backfilling the dataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#completing-the-pull-request" class="md-nav__link">
    Completing the Pull Request
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="a-quick-guide-to-creating-a-derived-dataset-with-bigquery-etl-and-how-to-set-it-up-as-a-public-dataset">A quick guide to creating a derived dataset with BigQuery-ETL and how to set it up as a public dataset</h1>
<p>This guide takes you through the creation of a simple derived dataset using bigquery-etl and scheduling it using Airflow, to be updated on a daily basis. It applies to the products we ship to customers, that use (or will use) the Glean SDK.</p>
<p>This guide also includes the specific instructions to set it as a <a href="https://blog.mozilla.org/data/2020/09/25/data-publishing-mozilla/">public dataset</a>.
<em>Make sure you only set the dataset public if you expect the data to be available outside Mozilla</em>. Read our <a href="https://mozilla.github.io/bigquery-etl/reference/public_data/">public datasets reference</a> for context.</p>
<p>To illustrate the overall process, we will use a simple test case and a small <a href="https://mozilla.github.io/glean/">Glean</a> application for which we want to generate an aggregated dataset based on the raw ping data.</p>
<p>If you are interested in looking at the end result, you can view the pull request at <a href="https://github.com/mozilla/bigquery-etl/pull/1760">mozilla/bigquery-etl#1760</a>.</p>
<h2 id="background">Background</h2>
<p><a href="https://mozilla.github.io/mozregression/">Mozregression</a> is a developer tool used to help developers and community members bisect builds of Firefox to find a regression range in which a bug was introduced. It forms a key part of our quality assurance process.</p>
<p>In this example, we will create a table of aggregated metrics related to <code>mozregression</code>, that will be used in dashboards to help prioritize feature development inside Mozilla.</p>
<h2 id="initial-steps">Initial steps</h2>
<p>Set up bigquery-etl on your system per the instructions in the <a href="https://github.com/mozilla/bigquery-etl/blob/main/README.md">README.md</a>.</p>
<h2 id="create-the-query">Create the Query</h2>
<p>The first step is to create a query file and decide on the name of your derived dataset. In this case, we'll name it <code>org_mozilla_mozregression_derived.mozregression_aggregates</code>.</p>
<p>The <code>org_mozilla_mozregression_derived</code> part represents a <a href="https://cloud.google.com/bigquery/docs/datasets-intro">BigQuery dataset</a>, which is essentially a container of tables. By convention, we use the <code>_derived</code> postfix to hold derived tables like this one.</p>
<p>Run:
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>create<span class="w"> </span>&lt;dataset&gt;.&lt;table_name&gt;
</code></pre></div>
In our example:</p>
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>create<span class="w"> </span>org_mozilla_mozregression_derived.mozregression_aggregates<span class="w"> </span>--dag<span class="w"> </span>bqetl_internal_tooling
</code></pre></div>
<p>This command does three things:</p>
<ul>
<li>Generate the template files <code>metadata.yaml</code> and <code>query.sql</code> representing the query to build the dataset in <code>sql/moz-fx-data-shared-prod/org_mozilla_mozregression_derived/mozregression_aggregates_v1</code></li>
<li>Generate a "view" of the dataset in <code>sql/moz-fx-data-shared-prod/org_mozilla_mozregression/mozregression_aggregates</code>.</li>
<li>Add the scheduling information in the metadata, required to create a task in Airflow DAG <code>bqetl_internal_tooling</code>.<ul>
<li>When the dag name is not given, the query is scheduled by default in DAG <code>bqetl_default</code>.</li>
<li>When the option <code>--no-schedule</code> is used, queries are not schedule. This option is available for queries that run once or should be scheduled at a later time. The query can be manually scheduled at a later time.</li>
</ul>
</li>
</ul>
<p>We generate the view to have a stable interface, while allowing the dataset backend to evolve over time. Views are automatically published to the <code>mozdata</code> project.</p>
<h2 id="fill-out-the-yaml">Fill out the YAML</h2>
<p>The next step is to modify the generated <code>metadata.yaml</code> and <code>query.sql</code> sections with specific information.</p>
<p>Let's look at what the <code>metadata.yaml</code> file for our example looks like. Make sure to adapt this file for your own dataset.</p>
<div class="highlight"><pre><span></span><code><span class="nt">friendly_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mozregression aggregates</span>
<span class="nt">description</span><span class="p">:</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Aggregated metrics of mozregression usage</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">  </span><span class="nt">incremental</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">owners</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wlachance@mozilla.com</span>
<span class="nt">bigquery</span><span class="p">:</span>
<span class="w">  </span><span class="nt">time_partitioning</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">day</span>
<span class="w">    </span><span class="nt">field</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">date</span>
<span class="w">    </span><span class="nt">require_partition_filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">expiration_days</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">clustering</span><span class="p">:</span>
<span class="w">    </span><span class="nt">fields</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app_used</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os</span>
</code></pre></div>
<p>Most of the fields are self-explanatory. <code>incremental</code> means that the table is updated incrementally, e.g. a new partition gets added/updated to the destination table whenever the query is run. For non-incremental queries the entire destination is overwritten when the query is executed.</p>
<p><a href="https://docs.telemetry.mozilla.org/cookbooks/bigquery/optimization.html">For big datasets make sure to include optimization strategies</a>. Our aggregation is small so it is only for illustration purposes that we are including a partition by the <code>date</code> field and a clustering on <code>app_used</code> and <code>os</code>.</p>
<h4 id="the-yaml-file-structure-for-a-public-dataset">The YAML file structure for a public dataset</h4>
<p>Setting the dataset as public means that it will be both in Mozilla's public BigQuery project and a world-accessible JSON endpoint, and is a process that requires a data review.
The required labels are: <code>public_json</code>, <code>public_bigquery</code> and <code>review_bugs</code> which refers to the Bugzilla bug where opening this data set up to the public was approved: we'll get to that in a subsequent section.</p>
<div class="highlight"><pre><span></span><code><span class="nt">friendly_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mozregression aggregates</span>
<span class="nt">description</span><span class="p">:</span>
<span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">Aggregated metrics of mozregression usage</span>
<span class="nt">labels</span><span class="p">:</span>
<span class="w">  </span><span class="nt">incremental</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">public_json</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">public_bigquery</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">review_bugs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1691105</span>
<span class="nt">owners</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wlachance@mozilla.com</span>
<span class="nt">bigquery</span><span class="p">:</span>
<span class="w">  </span><span class="nt">time_partitioning</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">day</span>
<span class="w">    </span><span class="nt">field</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">date</span>
<span class="w">    </span><span class="nt">require_partition_filter</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">expiration_days</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">clustering</span><span class="p">:</span>
<span class="w">    </span><span class="nt">fields</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app_used</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os</span>
</code></pre></div>
<h2 id="fill-out-the-query">Fill out the query</h2>
<p>Now that we've filled out the metadata, we can look into creating a query. In many ways, this is similar to creating a SQL query to run on BigQuery in other contexts (e.g. on sql.telemetry.mozilla.org or the BigQuery console)-- the key difference is that we use a <code>@submission_date</code> parameter so that the query can be run on a <em>day's worth</em> of data to update the underlying table incrementally.</p>
<p>Test your query and add it to the <code>query.sql</code> file.</p>
<p>In our example, the query is tested in <code>sql.telemetry.mozilla.org</code>, and the <code>query.sql</code> file looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span>
<span class="w">  </span><span class="nb">DATE</span><span class="p">(</span><span class="n">submission_timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">date</span><span class="p">,</span>
<span class="w">  </span><span class="n">client_info</span><span class="p">.</span><span class="n">app_display_version</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">mozregression_version</span><span class="p">,</span>
<span class="w">  </span><span class="n">metrics</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">usage_variant</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">mozregression_variant</span><span class="p">,</span>
<span class="w">  </span><span class="n">metrics</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">usage_app</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">app_used</span><span class="p">,</span>
<span class="w">  </span><span class="n">normalized_os</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">os</span><span class="p">,</span>
<span class="w">  </span><span class="n">mozfun</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="n">truncate_version</span><span class="p">(</span><span class="n">normalized_os_version</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;minor&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">os_version</span><span class="p">,</span>
<span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="k">DISTINCT</span><span class="p">(</span><span class="n">client_info</span><span class="p">.</span><span class="n">client_id</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">distinct_clients</span><span class="p">,</span>
<span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_uses</span>
<span class="k">FROM</span>
<span class="w">  </span><span class="o">`</span><span class="n">moz</span><span class="o">-</span><span class="n">fx</span><span class="o">-</span><span class="k">data</span><span class="o">-</span><span class="n">shared</span><span class="o">-</span><span class="n">prod</span><span class="o">`</span><span class="p">.</span><span class="n">org_mozilla_mozregression</span><span class="p">.</span><span class="k">usage</span>
<span class="k">WHERE</span>
<span class="w">  </span><span class="nb">DATE</span><span class="p">(</span><span class="n">submission_timestamp</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">submission_date</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">client_info</span><span class="p">.</span><span class="n">app_display_version</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%.dev%&#39;</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span>
<span class="w">  </span><span class="nb">date</span><span class="p">,</span>
<span class="w">  </span><span class="n">mozregression_version</span><span class="p">,</span>
<span class="w">  </span><span class="n">mozregression_variant</span><span class="p">,</span>
<span class="w">  </span><span class="n">app_used</span><span class="p">,</span>
<span class="w">  </span><span class="n">os</span><span class="p">,</span>
<span class="w">  </span><span class="n">os_version</span><span class="p">;</span>
</code></pre></div>
<p>We use the <code>truncate_version</code> UDF to omit the patch level for MacOS and Linux, which should both reduce the size of the dataset as well as make it more difficult to identify individual clients in an aggregated dataset.</p>
<p>We also have a short clause (<code>client_info.app_display_version NOT LIKE '%.dev%'</code>) to omit developer versions from the aggregates: this makes sure we're not including people developing or testing mozregression itself in our results.</p>
<h2 id="formatting-and-validating-the-query">Formatting and validating the query</h2>
<p>Now that we've written our query, we can format it and validate it. Once that's done, we run:</p>
<p><div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>validate<span class="w"> </span>&lt;dataset&gt;.&lt;table&gt;
</code></pre></div>
For our example:
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>validate<span class="w"> </span>org_mozilla_mozregression_derived.mozregression_aggregates_v1
</code></pre></div>
If there are no problems, you should see no output.</p>
<h2 id="creating-the-table-schema">Creating the table schema</h2>
<p>Use bqetl to set up the schema that will be used to create the table.</p>
<p>Review the schema.YAML generated as an output of the following command, and make sure all data types are set correctly and according to the data expected from the query.</p>
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>schema<span class="w"> </span>update<span class="w"> </span>&lt;dataset&gt;.&lt;table&gt;<span class="sb">`</span>
</code></pre></div>
<p>For our example:
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>schema<span class="w"> </span>update<span class="w"> </span>org_mozilla_mozregression_derived.mozregression_aggregates_v1
</code></pre></div></p>
<h2 id="creating-a-dag">Creating a DAG</h2>
<p>BigQuery-ETL has some facilities in it to automatically add your query to <a href="https://github.com/mozilla/telemetry-airflow">telemetry-airflow</a> (our instance of Airflow).</p>
<p>Before scheduling your query, you'll need to find an <a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts.html#dags">Airflow DAG</a> to run it off of. In some cases, one may already exist that makes sense to use for your dataset -- look in <code>dags.yaml</code> at the root or run <code>./bqetl dag info</code>. In this particular case, there's no DAG that really makes sense -- so we'll create a new one:</p>
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>dag<span class="w"> </span>create<span class="w"> </span>&lt;dag_name&gt;<span class="w"> </span>--schedule-interval<span class="w"> </span><span class="s2">&quot;0 4 * * *&quot;</span><span class="w"> </span>--owner<span class="w"> </span>&lt;email_for_notifications&gt;<span class="w"> </span>--description<span class="w"> </span><span class="s2">&quot;Add a clear description of the DAG here&quot;</span><span class="w"> </span>--start-date<span class="w"> </span>&lt;YYYY-MM-DD&gt;<span class="w"> </span>--tag<span class="w"> </span>impact/&lt;tier&gt;
</code></pre></div>
<p>For our example, the starting date is <code>2020-06-01</code> and we use a schedule interval of <code>0 4 \* \* \*</code> (4am UTC daily) instead of "daily" (12am UTC daily) to make sure this isn't competing for slots with desktop and mobile product ETL.</p>
<p>The <code>--tag impact/tier3</code> parameter specifies that this DAG is considered "tier 3". For a list of valid tags and their descriptions see <a href="../../reference/airflow_tags/">Airflow Tags</a>.</p>
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>dag<span class="w"> </span>create<span class="w"> </span>bqetl_internal_tooling<span class="w"> </span>--schedule-interval<span class="w"> </span><span class="s2">&quot;0 4 * * *&quot;</span><span class="w"> </span>--owner<span class="w"> </span>wlachance@mozilla.com<span class="w"> </span>--description<span class="w"> </span><span class="s2">&quot;This DAG schedules queries for populating queries related to Mozilla&#39;s internal developer tooling (e.g. mozregression).&quot;</span><span class="w"> </span>--start-date<span class="w"> </span><span class="m">2020</span>-06-01<span class="w"> </span>--tag<span class="w"> </span>impact/tier_3
</code></pre></div>
<h2 id="scheduling-your-query">Scheduling your query</h2>
<p>Queries are automatically scheduled during creation in the DAG set using the option <code>--dag</code>, or in the default DAG <code>bqetl_default</code> when this option is not used.</p>
<p>If the query was created with <code>--no-schedule</code>, it is possible to manually schedule the query via the <code>bqetl</code> tool:</p>
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>schedule<span class="w"> </span>&lt;dataset&gt;.&lt;table&gt;<span class="w"> </span>--dag<span class="w"> </span>&lt;dag_name&gt;<span class="w"> </span>--task-name<span class="w"> </span>&lt;task_name&gt;
</code></pre></div>
<p>Here is the command for our example. Notice the name of the table as created with the suffix _v1.
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>schedule<span class="w"> </span>org_mozilla_mozregression_derived.mozregression_aggregates_v1<span class="w"> </span>--dag<span class="w"> </span>bqetl_internal_tooling<span class="w"> </span>--task-name<span class="w"> </span>mozregression_aggregates__v1
</code></pre></div></p>
<p>Note that we are scheduling the generation of the underlying <em>table</em> which is <code>org_mozilla_mozregression_derived.mozregression_aggregates_v1</code> rather than the view.</p>
<h2 id="updating-the-airflow-dags">Updating the Airflow DAGs</h2>
<p>With the query schedule setup, you will want to generate the actual airflow configuration which telemetry-airflow will pick up. Run:</p>
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>dag<span class="w"> </span>generate<span class="w"> </span>&lt;dag_name&gt;
</code></pre></div>
<p>For this example:
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>dag<span class="w"> </span>generate<span class="w"> </span>bqetl_internal_tooling
</code></pre></div></p>
<p>This may take a while, as it currently does a dry run through every query defined in bigquery-etl.</p>
<h2 id="get-data-review">Get Data Review</h2>
<p><em>This is for public datasets only! You can skip this step if you're only creating a dataset for Mozilla-internal use.</em></p>
<p>Before a dataset can be made public, it needs to go through data review according to our <a href="https://wiki.mozilla.org/Data_Publishing#Dataset_Publishing_Process_2">data publishing process</a>. This means filing a bug, answering a few questions, and then finding a <a href="https://wiki.mozilla.org/Firefox/Data_Collection">data steward</a> to review your proposal.</p>
<p>The dataset we're using in this example is very simple and straightforward and does not have any particularly sensitive data, so the data review is very simple. You can see the full details in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1691105">bug 1691105</a>.</p>
<h2 id="create-a-pull-request">Create a Pull Request</h2>
<p>Now is a good time to create a pull request with your changes to GitHub. This is the usual git workflow:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>&lt;new_branch_name&gt;
git<span class="w"> </span>add<span class="w"> </span>dags.yaml<span class="w"> </span>dags/&lt;dag_name&gt;.py<span class="w"> </span>sql/moz-fx-data-shared-prod/telemetry/&lt;view&gt;<span class="w"> </span>sql/moz-fx-data-shared-prod/&lt;dataset&gt;/&lt;table&gt;
git<span class="w"> </span>commit
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>&lt;new_branch_name&gt;
</code></pre></div>
<p>And next is the workflow for our specific example:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>mozregression-aggregates
git<span class="w"> </span>add<span class="w"> </span>dags.yaml<span class="w"> </span>dags/bqetl_internal_tooling.py<span class="w"> </span>sql/moz-fx-data-shared-prod/org_mozilla_mozregression/mozregression_aggregates<span class="w"> </span>sql/moz-fx-data-shared-prod/org_mozilla_mozregression_derived/mozregression_aggregates_v1
git<span class="w"> </span>commit
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>mozregression-aggregates
</code></pre></div>
<p>Then create your pull request, either from the GitHub web interface or the command line, per your preference.</p>
<p><strong>Note</strong> At this point, the CI is expected to fail because the schema does not exist yet in BigQuery. This will be handled in the next step.</p>
<p>This example assumes that <code>origin</code> points to your fork. Adjust the last push invocation appropriately if you have a different <a href="https://git-scm.com/docs/git-remote">remote</a> set.</p>
<p>Speaking of forks, note that if you're making this pull request from a fork, many jobs will currently fail due to lack of credentials. In fact, even if you're pushing to the origin, you'll get failures because the table is not yet created. That brings us to the next step, but before going further it's generally best to get someone to review your work: at this point we have more than enough for people to provide good feedback on.</p>
<h2 id="creating-an-initial-table">Creating an initial table</h2>
<p>Once the PR has been approved, deploy the schema to bqetl using this command:</p>
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>schema<span class="w"> </span>deploy<span class="w"> </span>&lt;schema&gt;.&lt;table&gt;
</code></pre></div>
<p>For our example:
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>schema<span class="w"> </span>deploy<span class="w"> </span>org_mozilla_mozregression_derived.mozregression_aggregates_v1
</code></pre></div></p>
<h2 id="backfilling-the-dataset">Backfilling the dataset</h2>
<p>It is recommended to use the <a href="https://mozilla.github.io/bigquery-etl/bqetl/#backfill">bqetl backfill command</a> in order to load the data in your new table, and set specific dates for large sets of data, as well as following the <a href="https://mozilla.github.io/bigquery-etl/reference/recommended_practices/#backfills">recommended practices</a>.</p>
<div class="highlight"><pre><span></span><code>bqetl<span class="w"> </span>query<span class="w"> </span>backfill<span class="w"> </span>&lt;dataset&gt;.&lt;table&gt;<span class="w"> </span>--project_id<span class="o">=</span>moz-fx-data-shared-prod<span class="w"> </span>-s<span class="w"> </span>&lt;YYYY-MM-DD&gt;<span class="w"> </span>-e<span class="w"> </span>&lt;YYYY-MM-DD&gt;<span class="w"> </span>-n<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>For our example:
<div class="highlight"><pre><span></span><code>./bqetl<span class="w"> </span>query<span class="w"> </span>backfill<span class="w"> </span>org_mozilla_mozregression_derived.mozregression_aggregates_v1<span class="w"> </span>--s<span class="w"> </span><span class="m">2020</span>-04-01<span class="w"> </span>--e<span class="w"> </span><span class="m">2021</span>-02-01
</code></pre></div></p>
<p><strong>Note</strong>. Alternatively, you can trigger the Airflow DAG to backfill the data. In this case, it is recommended to talk to someone in in Data Engineering or Data SRE to trigger the DAG.</p>
<h2 id="completing-the-pull-request">Completing the Pull Request</h2>
<p>At this point, the table exists in Bigquery so you are able to:
- <a href="https://app.circleci.com/pipelines/github/mozilla/bigquery-etl?">Find and re-run the CI</a> of your PR and make sure that all tests pass
- Merge your PR.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>